generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum TodoStatus {
  TODO
  DOING
  DONE
  CANCELLED
}

enum TodoPriority {
  NONE
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum NotificationType {
  TODO_CREATED
  TODO_UPDATED
  TODO_DELETED
  TODO_COMMENTED
  TODO_REACTED
  LIST_SHARED
}

enum RecurrencePattern {
  NONE
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum RecurrenceType {
  SIMPLE
  INTERVAL
  WEEKDAYS
  MONTHDAY
  COMPLEX
}

enum EmailNotificationFrequency {
  IMMEDIATE
  DAILY
  WEEKLY
  NEVER
}

enum ActivityType {
  TODO_CREATED
  TODO_UPDATED
  TODO_DELETED
  TODO_STATUS_CHANGED
  TODO_PRIORITY_CHANGED
  TODO_ASSIGNED_TO_LIST
  TODO_MOVED_TO_LIST
  LIST_CREATED
  LIST_UPDATED
  LIST_DELETED
  LIST_SHARED
  LIST_UNSHARED
  COMMENT_ADDED
  COMMENT_DELETED
  REACTION_ADDED
  REACTION_REMOVED
  ATTACHMENT_ADDED
  ATTACHMENT_DELETED
  BATCH_UPDATE
  BATCH_DELETE
  DEPENDENCY_ADDED
  DEPENDENCY_REMOVED
}

model User {
  id                          String                       @id @default(cuid())
  email                       String                       @unique
  name                        String?
  emailNotificationFrequency  EmailNotificationFrequency   @default(IMMEDIATE)
  lastDigestSentAt            DateTime?
  digestIncludeTodoCreated    Boolean                      @default(true)
  digestIncludeTodoUpdated    Boolean                      @default(true)
  digestIncludeTodoDeleted    Boolean                      @default(true)
  digestIncludeTodoCommented  Boolean                      @default(true)
  digestIncludeTodoReacted    Boolean                      @default(true)
  digestIncludeListShared     Boolean                      @default(true)
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt

  todos         Todo[]
  lists         List[]
  listShares    ListShare[]
  comments      Comment[]
  reactions     Reaction[]
  notifications Notification[]
  attachments   Attachment[]
  templates     Template[]
  activityLogs  ActivityLog[]
}

model Todo {
  id                    String            @id @default(cuid())
  title                 String
  description           String?
  status                TodoStatus        @default(TODO)
  priority              TodoPriority      @default(NONE)
  userId                String
  listId                String?
  dueDate               DateTime?
  recurrencePattern     RecurrencePattern @default(NONE)
  recurrenceType        RecurrenceType    @default(SIMPLE)
  recurrenceInterval    Int?
  recurrenceDaysOfWeek  String?
  recurrenceDayOfMonth  Int?
  recurrenceWeekOfMonth Int?
  recurrenceMonthDay    String?
  recurrenceEndDate     DateTime?
  parentRecurringTodoId String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  list                List?               @relation(fields: [listId], references: [id], onDelete: SetNull)
  parentRecurringTodo Todo?               @relation("RecurringInstances", fields: [parentRecurringTodoId], references: [id], onDelete: SetNull)
  childInstances      Todo[]              @relation("RecurringInstances")
  comments            Comment[]
  reactions           Reaction[]
  notifications       Notification[]
  attachments         Attachment[]
  activityLogs        ActivityLog[]
  blockedBy           TodoDependency[]    @relation("BlockedBy")
  blocking            TodoDependency[]    @relation("Blocking")

  @@index([userId])
  @@index([listId])
  @@index([parentRecurringTodoId])
}

model List {
  id        String   @id @default(cuid())
  name      String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  todos         Todo[]
  shares        ListShare[]
  notifications Notification[]
  activityLogs  ActivityLog[]

  @@index([userId])
}

model ListShare {
  id        String   @id @default(cuid())
  listId    String
  userId    String
  createdAt DateTime @default(now())

  list List @relation(fields: [listId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([listId, userId])
  @@index([listId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  todoId    String
  userId    String
  createdAt DateTime @default(now())

  todo Todo @relation(fields: [todoId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([todoId])
  @@index([userId])
}

model Reaction {
  id        String   @id @default(cuid())
  emoji     String
  todoId    String
  userId    String
  createdAt DateTime @default(now())

  todo Todo @relation(fields: [todoId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([todoId, userId, emoji])
  @@index([todoId])
  @@index([userId])
}

model Notification {
  id               String           @id @default(cuid())
  type             NotificationType
  message          String
  read             Boolean          @default(false)
  includedInDigest Boolean          @default(false)
  userId           String
  todoId           String?
  listId           String?
  actorId          String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  todo  Todo? @relation(fields: [todoId], references: [id], onDelete: Cascade)
  list  List? @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([todoId])
  @@index([listId])
  @@index([actorId])
}

model Attachment {
  id        String   @id @default(cuid())
  filename  String
  filepath  String
  mimetype  String
  size      Int
  todoId    String
  userId    String
  createdAt DateTime @default(now())

  todo Todo @relation(fields: [todoId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([todoId])
  @@index([userId])
}

model Template {
  id                String            @id @default(cuid())
  name              String
  title             String
  description       String?
  priority          TodoPriority      @default(NONE)
  recurrencePattern RecurrencePattern @default(NONE)
  recurrenceType        RecurrenceType    @default(SIMPLE)
  recurrenceInterval    Int?
  recurrenceDaysOfWeek  String?
  recurrenceDayOfMonth  Int?
  recurrenceWeekOfMonth Int?
  recurrenceMonthDay    String?
  userId            String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ActivityLog {
  id           String       @id @default(cuid())
  activityType ActivityType
  description  String
  metadata     String?
  userId       String
  todoId       String?
  listId       String?
  createdAt    DateTime     @default(now())

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  todo Todo? @relation(fields: [todoId], references: [id], onDelete: Cascade)
  list List? @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([todoId])
  @@index([listId])
  @@index([createdAt])
}

model TodoDependency {
  id              String   @id @default(cuid())
  todoId          String
  dependsOnTodoId String
  createdAt       DateTime @default(now())

  todo          Todo @relation("BlockedBy", fields: [todoId], references: [id], onDelete: Cascade)
  dependsOnTodo Todo @relation("Blocking", fields: [dependsOnTodoId], references: [id], onDelete: Cascade)

  @@unique([todoId, dependsOnTodoId])
  @@index([todoId])
  @@index([dependsOnTodoId])
}
